---
title: 常见系统设计题系列-即时通信系统
date: 2021-01-19 15:48:03
updated:
mathjax: true
categories:
- [系统设计]
tags: 
---

设计要点：

长链接接入网关

- 接入层：如何做负载均衡（基于IP 还是 基于7层的用户唯一标识）
- 就近接入
- 接入层如何升级：尽量减少升级（否则断开连接），拆分为负责连接的进程与负责处理业务的进程，两者之间通过共享内存通信

<!-- more -->

心跳设计

- 作用：保活
- 原则：省电 PK 服务器压力

通信协议：采用TCP/HTTP相结合的方式

- TCP用于低延迟通知类
- HTTP主要用于拉消息等对延迟不敏感的场景

协议设计

- 数据安全性
- 编码复杂度
- 协议通用型
- 数据大小

重连策略（客户端与服务端配合）

当一台网关出现问题需要客户端进行重连时，还需要考虑到：不要因为重连问题导致了其他网关服务器也受影响，产生雪崩效应，此时需要考虑以下几点：

- 打散重连时间：需要进行重连的客户端，在一个时间范围内选择一个随机的时间，这样将这些客户端的重连时间打散，不至于一下子都连接上来。
- 指数退避：一次重连不上时，客户端还需要再次尝试进行多次重连，然而重连的时间需要像TCP协议那样在阻塞恢复时做指数退避，即第一次重连时间是1秒后，第二次2秒后，第三次4秒后，等等。这个策略也是为了避免由于重连导致的服务雪崩。
- 服务器保护：上面两条是客户端的重连策略，然而服务器自身也需要进行保护，当服务器判断自己当前的负载到一定程度时，将拒绝客户端的连接请求。

如何保证消息可达(不丢)/唯一(不重复)/保序(不乱序)

- 不乱序：每条消息都有一条唯一且自增的msg_id
- 不重复：

消息防丢失

- 逐条ACK
- 引入seqno机制：为每一个用户维护一个自增的序列号

存储设计

- 消息存储库：存储每一个回话下的每一条消息，用于读扩散或者消息漫游；存储周期：长
- 消息同步库：为每一个用户存储一个使用TIMELINE模型的收件箱，用于读取最新消息（一般是写扩散写入）；存储周期：短
- 万人大群是例外，如果一定要支持的话，可以采用读写扩散混合模式。

接入层怎么做
实现接入层的负载均衡主要有以下几个方法：

硬件负载均衡：例如 F5、A10 等等。硬件负载均衡性能强大，稳定性高，但价格非常贵，不是土豪公司不建议使用。

使用 DNS 实现负载均衡：使用 DNS 实现负载均衡比较简单，但使用 DNS 实现负载均衡如果需要切换或者扩容那生效会很慢，而且使用 DNS 实现负载均衡支持的 IP 个数有限制、支持的负载均衡策略也比较简单。

DNS + 4 层负载均衡 + 7 层负载均衡架构：例如 DNS + DPVS + Nginx 或者 DNS + LVS + Nginx。有人可能会疑惑为什么要加入 4 层负载均衡呢？这是因为 7 层负载均衡很耗 CPU，并且经常需要扩容或者缩容，对于大型网站来说可能需要很多 7 层负载均衡服务器，但只需要少量的 4 层负载均衡服务器即可。因此，该架构对于 HTTP 等短连接大型应用很有用。当然，如果流量不大的话只使用 DNS + 7 层负载均衡即可。但对于长连接来说，加入 7 层负载均衡 Nginx 就不大好了。因为 Nginx 经常需要改配置并且 reload 配置，reload 的时候 TCP 连接会断开，造成大量掉线。

DNS + 4 层负载均衡：4 层负载均衡一般比较稳定，很少改动，比较适合于长连接。

对于长连接的接入层，如果我们需要更加灵活的负载均衡策略或者需要做灰度的话，那我们可以引入一个调度服务，如下图所示：


Access Schedule Service 可以实现根据各种策略来分配 Access Service，例如：

根据灰度策略来分配

根据就近原则来分配

根据最少连接数来分配

https://xie.infoq.cn/article/19e95a78e2f5389588debfb1c

接入层怎么做
实现接入层的负载均衡主要有以下几个方法：

硬件负载均衡：例如 F5、A10 等等。硬件负载均衡性能强大，稳定性高，但价格非常贵，不是土豪公司不建议使用。

使用 DNS 实现负载均衡：使用 DNS 实现负载均衡比较简单，但使用 DNS 实现负载均衡如果需要切换或者扩容那生效会很慢，而且使用 DNS 实现负载均衡支持的 IP 个数有限制、支持的负载均衡策略也比较简单。

DNS + 4 层负载均衡 + 7 层负载均衡架构：例如 DNS + DPVS + Nginx 或者 DNS + LVS + Nginx。有人可能会疑惑为什么要加入 4 层负载均衡呢？这是因为 7 层负载均衡很耗 CPU，并且经常需要扩容或者缩容，对于大型网站来说可能需要很多 7 层负载均衡服务器，但只需要少量的 4 层负载均衡服务器即可。因此，该架构对于 HTTP 等短连接大型应用很有用。当然，如果流量不大的话只使用 DNS + 7 层负载均衡即可。但对于长连接来说，加入 7 层负载均衡 Nginx 就不大好了。因为 Nginx 经常需要改配置并且 reload 配置，reload 的时候 TCP 连接会断开，造成大量掉线。

DNS + 4 层负载均衡：4 层负载均衡一般比较稳定，很少改动，比较适合于长连接。

对于长连接的接入层，如果我们需要更加灵活的负载均衡策略或者需要做灰度的话，那我们可以引入一个调度服务，如下图所示：

Access Schedule Service 可以实现根据各种策略来分配 Access Service，例如：

根据灰度策略来分配

根据就近原则来分配

根据最少连接数来分配